
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.8">
    
    
      
        <title>Agency Onboarding Runbook - GRaaS Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#agency-onboarding-runbook" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="GRaaS Documentation" class="md-header__button md-logo" aria-label="GRaaS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GRaaS Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Agency Onboarding Runbook
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="GRaaS Documentation" class="md-nav__button md-logo" aria-label="GRaaS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    GRaaS Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Intro to GRaaS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../attribution/" class="md-nav__link">
        Attribution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Developer setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developer setup" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Developer setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../new-instance-setup/" class="md-nav__link">
        Setting up a new instance of GRaaS
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Agency Onboarding Runbook
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Agency Onboarding Runbook
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#onboarder-prerequisites" class="md-nav__link">
    Onboarder prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agency-prerequisites" class="md-nav__link">
    Agency prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service-data-for-agency" class="md-nav__link">
    Create service data for agency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-keys-for-agency" class="md-nav__link">
    Create keys for agency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-setup" class="md-nav__link">
    Device Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-maintenance" class="md-nav__link">
    Device Maintenance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-troubleshooting" class="md-nav__link">
    General troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/" class="md-nav__link">
        GRaaS hardware intro and assembly
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Testing
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Testing" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Testing
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../testing/trip-inference/" class="md-nav__link">
        Trip Inference
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../python-docs/" class="md-nav__link">
        Python docs
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#onboarder-prerequisites" class="md-nav__link">
    Onboarder prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agency-prerequisites" class="md-nav__link">
    Agency prerequisites
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service-data-for-agency" class="md-nav__link">
    Create service data for agency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-keys-for-agency" class="md-nav__link">
    Create keys for agency
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-setup" class="md-nav__link">
    Device Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#device-maintenance" class="md-nav__link">
    Device Maintenance
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#general-troubleshooting" class="md-nav__link">
    General troubleshooting
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="agency-onboarding-runbook">Agency Onboarding Runbook</h1>
<h2 id="onboarder-prerequisites">Onboarder prerequisites</h2>
<p><code>Onboarder</code> refers to the person performing the agency onboarding. Oboarder requires:
- <code>Editor</code> access to google cloud project
- the following command line tools:
  - <code>git</code>
  - <code>gcloud</code>
  - <code>gsutil</code>
- clone two git repos: graas &amp; graas-agency-keys.</p>
<p><strong>TODO</strong>: dockerize onboarding</p>
<h2 id="agency-prerequisites">Agency prerequisites</h2>
<ul>
<li>agency must have a publicly available static GTFS URL, including headsigns for each trip. You can verify that a given URL is valid by</li>
<li>downloading the contents of the URL with the command <code>curl -o gtfs.zip &lt;agency-gtfs-url&gt;</code></li>
<li>unpacking the zip with <code>unzip gtfs.zip</code></li>
<li>this should yield files like agency.txt, trips.txt, routes.txt, etc.</li>
<li>agency needs to provide a list of vehicle IDs to uniquely identify each service vehicle. For smaller agencies who don't have existing vehicle IDs, this could be the last three digits of the VIN</li>
<li>agency needs to provide a list of friendly trip names for the drivers to choose from when starting the web app. The default way of naming trips is to combine the head sign for each trip with the departure time at the first stop, e.g. <code>Venice Beach @ 3:05 pm</code>. If the agency doesn't find this scheme acceptable, then they need to provide a list of trip names. There is a tool available <a href="https://github.com/cal-itp/gtfu/blob/master/scripts/trip-list-generator.sh">here</a> that automatically generates a list of trip names in the default scheme.</li>
</ul>
<h2 id="create-service-data-for-agency">Create service data for agency</h2>
<ul>
<li>Go to <a href="https://github.com/cal-itp/data-infra/blob/main/airflow/data/agencies.yml">agencies.yml</a>, a Cal-ITP source-of-truth, in order to determine the agency-id for this agency.</li>
<li>Create a new branch</li>
<li>From <code>graas/server/agency-config/gtfs</code>, run the command <code>./setup-agency-templates.sh &lt;id&gt;</code>. This will create a directory for the agency at <code>graas/server/agency-config/gtfs/gtfs-aux/&lt;agency-id&gt;</code>, containing 3 files:<ul>
<li>agency-params.json</li>
<li>trip-names.json</li>
<li>vehicle-ids.json</li>
</ul>
</li>
<li>Add the vehicle IDs provided by the agency to <code>vehicle-ids.json</code>. Assuming the agency has IDs <code>001</code>, <code>002</code> and <code>003</code> the the file should look like this:</li>
</ul>
<pre><code>[
    &quot;001&quot;,
    &quot;002&quot;,
    &quot;003&quot;
]
</code></pre>
<ul>
<li>Update the values in agency-params.json to accomodate your agency. Options for <code>triplist-generator-namefield</code>:<ul>
<li>headsign</li>
<li>route_short_name</li>
<li>route_long_name</li>
<li>shape_id</li>
</ul>
</li>
<li>Create a new pull request containing updates to agency-params.json &amp; vehicle-ids.json. Agency-params.json needs to be updated on the main branch in order to run the following command.</li>
<li>Within the gtfu directory, run the command <code>java -cp build/libs/gtfu.jar gtfu.tools.TripListGenerator -a &lt;agency-id&gt; -v</code>. You can try different values for <code>triplist-generator-namefield</code> and <code>triplist-generator-use-direction</code> until the output looks good. Once the output is satisfactory, run the same command with the "-l" flag to update the trip-names.json file directly. The file will look something like this.</li>
</ul>
<pre><code>[
    {&quot;route_name&quot;: &quot;Valley West (Northbound) @ 1:59 pm&quot;, &quot;trip_id&quot;: &quot;t_1194609_b_26559_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.780441, &quot;long&quot;: -124.188820}},
    {&quot;route_name&quot;: &quot;Valley West (Northbound) @ 4:12 pm&quot;, &quot;trip_id&quot;: &quot;t_1194610_b_26559_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.780441, &quot;long&quot;: -124.188820}},
    {&quot;route_name&quot;: &quot;Valley West (Northbound) @ 5:07 pm&quot;, &quot;trip_id&quot;: &quot;t_1194611_b_26559_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.780441, &quot;long&quot;: -124.188820}},
    {&quot;route_name&quot;: &quot;Willow Creek (Eastbound) @ 8:25 am&quot;, &quot;trip_id&quot;: &quot;t_1522946_b_30738_tn_0&quot;, &quot;calendar&quot;: [1, 1, 1, 1, 1, 0, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.868565, &quot;long&quot;: -124.084099}},
    {&quot;route_name&quot;: &quot;Willow Creek (Eastbound) @ 8:25 am&quot;, &quot;trip_id&quot;: &quot;t_1522952_b_30738_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.868565, &quot;long&quot;: -124.084099}},
    {&quot;route_name&quot;: &quot;Willow Creek (Eastbound) @ 10:40 am&quot;, &quot;trip_id&quot;: &quot;t_1522950_b_30738_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.868565, &quot;long&quot;: -124.084099}},
    {&quot;route_name&quot;: &quot;Willow Creek (Eastbound) @ 3:45 pm&quot;, &quot;trip_id&quot;: &quot;t_1522945_b_30738_tn_0&quot;, &quot;calendar&quot;: [1, 1, 1, 1, 1, 0, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.874722, &quot;long&quot;: -124.084763}},
    {&quot;route_name&quot;: &quot;Willow Creek (Eastbound) @ 5:40 pm&quot;, &quot;trip_id&quot;: &quot;t_1522951_b_30738_tn_0&quot;, &quot;calendar&quot;: [0, 0, 0, 0, 0, 1, 0], &quot;departure_pos&quot;: {&quot;lat&quot;: 40.868565, &quot;long&quot;: -124.084099}}
]

</code></pre>
<ul>
<li>Confirm that none of the calendar arrays are null. If they are, those routes will be hidden by default, and you should ask the agency to update the GTFS feed</li>
<li>Create a PR on the GRaaS repo containing these three new files. Since the web app refers to Github as a source of truth, merging this PR updates production.</li>
<li>Update the file <code>live-agencies.txt</code>, which lives on the GRaaS storage bucket, to include the agency-id
<a href="https://github.com/cal-itp/graas/issues/86">TODO</a>: Automatically perform this update</li>
</ul>
<h2 id="create-keys-for-agency">Create keys for agency</h2>
<p>From <code>graas/server/app-engine</code>, run <code>python keygen.py -a &lt;agency-id&gt;</code>. This uploads the public key to Google Cloud and generates a folder called <code>&lt;agency-id&gt;</code> with two files inside it:
- <strong>id_ecdsa</strong>: private key. This is <strong>PRIVILEGED INFORMATION</strong> and needs to be kept confidential.
- <strong>id_ecdsa.pub</strong>: public key</p>
<ul>
<li>
<p>Move this new agency key folder to the graas-agency-keys repo (or elsewhere if you prefer). This is privleged information and shouldn't live on the open-source repo.</p>
</li>
<li>
<p>Create a unique agency QR code, which encodes the private key, to be read by the GRaaS app. Generate the code by going to the <code>graas/server/qr-gen</code> directory and running <code>./run.sh ../../../graas-agency-keys/&lt;agency-id&gt;/id_ecdsa "&lt;nickname for agency&gt;"</code>. This will save a file called "qr.png" to the qr-gen folder - you'll want to paste this into the onboarding docs provided to the agency. <strong>Since this QR code contains the private key, it should handled, shared and deleted carefully</strong>.</p>
</li>
<li>You can visit <a href="https://console.cloud.google.com/datastore/entities;kind=agency">this page</a> to confirm the key was added to Google datastore</li>
</ul>
<h2 id="device-setup">Device Setup</h2>
<ul>
<li>On agency device, visit the <a href="https://&lt;PROJECT-ID&gt;.wl.r.appspot.com/">web app</a> and create "home screen shortcut" to this URL (e.g. for iOS see <a href="https://www.macrumors.com/how-to/add-a-web-link-to-home-screen-iphone-ipad">here</a>)</li>
<li>Open web app via home screen. Grant camera access to the app and scan the agency QR code. This will save the private key to the device.</li>
<li>Press <code>Start</code>, then select an arbitrary route and vehicle and press <code>Okay</code>. Press <code>Allow</code> for the Location Services dialog that appears, then press the <code>Stop</code> button in the app.</li>
</ul>
<h2 id="device-maintenance">Device Maintenance</h2>
<p>All devices used for GPS data collection need to be rebooted once a week.</p>
<h2 id="general-troubleshooting">General troubleshooting</h2>
<ul>
<li>To check whether an agency is publishing data, run the command <code>gcloud app logs tail</code></li>
<li>If the agency isn't seeing seeing any route results from the dropdown, confirm that they are starting the app while physically near the first stop (1/4 mile) and within 30 minutes of the start time. If it still isnt working, edit the parameters in agency-params.json (note that if they don't have parameters listed, the app defaults to some - you can see in app-engine/templates/staging.html line 1094).</li>
<li>If you need to get the logs for a given day, run the following command from venv within the app-engine directory: <code>python get-pos.py -a &lt;agency-id&gt; -d MM/DD/YY -t &gt; &lt;agency-name&gt;-MM-DD-YY.log</code></li>
</ul>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../../new-instance-setup/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Setting up a new instance of GRaaS" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Setting up a new instance of GRaaS
            </div>
          </div>
        </a>
      
      
        
        <a href="../../hardware/" class="md-footer__link md-footer__link--next" aria-label="Next: GRaaS hardware intro and assembly" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              GRaaS hardware intro and assembly
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.0238f547.min.js"></script>
      
    
  </body>
</html>