
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.8">
    
    
      
        <title>Python docs - GRaaS Documentation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.644de097.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#server.app-engine" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="GRaaS Documentation" class="md-header__button md-logo" aria-label="GRaaS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            GRaaS Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Python docs
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="GRaaS Documentation" class="md-nav__button md-logo" aria-label="GRaaS Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    GRaaS Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          About
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="About" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          About
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Intro to GRaaS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../attribution/" class="md-nav__link">
        Attribution
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Developer setup
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developer setup" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Developer setup
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../new-instance-setup/" class="md-nav__link">
        Setting up a new instance of GRaaS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../server/onboarding-runbook/" class="md-nav__link">
        Agency Onboarding Runbook
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../hardware/" class="md-nav__link">
        GRaaS hardware intro and assembly
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Python docs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Python docs
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server.app-engine" class="md-nav__link">
    server.app-engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt" class="md-nav__link">
    gtfsrt
  </a>
  
    <nav class="md-nav" aria-label="gtfsrt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_alert_feed" class="md-nav__link">
    get_alert_feed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_current_block_collection" class="md-nav__link">
    get_current_block_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_position_feed" class="md-nav__link">
    get_position_feed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_trip_id" class="md-nav__link">
    get_trip_id()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_block_collection" class="md-nav__link">
    handle_block_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_get_assignments" class="md-nav__link">
    handle_get_assignments()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_pos_update" class="md-nav__link">
    handle_pos_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.load_block_metadata" class="md-nav__link">
    load_block_metadata()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.main" class="md-nav__link">
    main
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.util" class="md-nav__link">
    util
  </a>
  
    <nav class="md-nav" aria-label="util">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_current_time_millis" class="md-nav__link">
    get_current_time_millis()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_epoch_seconds" class="md-nav__link">
    get_epoch_seconds()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_midnight_seconds" class="md-nav__link">
    get_midnight_seconds()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_seconds_since_midnight" class="md-nav__link">
    get_seconds_since_midnight()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_yyyymmdd" class="md-nav__link">
    get_yyyymmdd()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.read_public_keys" class="md-nav__link">
    read_public_keys()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.verify_signature" class="md-nav__link">
    verify_signature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#server.app-engine" class="md-nav__link">
    server.app-engine
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt" class="md-nav__link">
    gtfsrt
  </a>
  
    <nav class="md-nav" aria-label="gtfsrt">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_alert_feed" class="md-nav__link">
    get_alert_feed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_current_block_collection" class="md-nav__link">
    get_current_block_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_position_feed" class="md-nav__link">
    get_position_feed()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.get_trip_id" class="md-nav__link">
    get_trip_id()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_block_collection" class="md-nav__link">
    handle_block_collection()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_get_assignments" class="md-nav__link">
    handle_get_assignments()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.handle_pos_update" class="md-nav__link">
    handle_pos_update()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.gtfsrt.load_block_metadata" class="md-nav__link">
    load_block_metadata()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.main" class="md-nav__link">
    main
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#server.app-engine.util" class="md-nav__link">
    util
  </a>
  
    <nav class="md-nav" aria-label="util">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_current_time_millis" class="md-nav__link">
    get_current_time_millis()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_epoch_seconds" class="md-nav__link">
    get_epoch_seconds()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_midnight_seconds" class="md-nav__link">
    get_midnight_seconds()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_seconds_since_midnight" class="md-nav__link">
    get_seconds_since_midnight()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.get_yyyymmdd" class="md-nav__link">
    get_yyyymmdd()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.read_public_keys" class="md-nav__link">
    read_public_keys()
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server.app-engine.util.verify_signature" class="md-nav__link">
    verify_signature()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>Python docs</h1>

<div class="doc doc-object doc-module">

<a id="server.app-engine"></a>
    <div class="doc doc-contents first">




  <div class="doc doc-children">

















  <div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="server.app-engine.gtfsrt">
        <code>gtfsrt</code>



</h2>

    <div class="doc doc-contents ">

      <p>GTFS-rt server business logic and some utility functions regarding DB access and protobuf structures.</p>



  <div class="doc doc-children">



















  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.get_alert_feed">
<code class="highlight language-python"><span class="n">get_alert_feed</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Assemble alert feed for an agency in the <a href="https://developers.google.com/protocol-buffers">protobuf format</a>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency</code></td>
        <td><code>str</code></td>
        <td><p>an agency ID.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>obj</code></td>
      <td><p>alert feed in protobuf format</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_alert_feed</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assemble alert feed for an agency in the [protobuf format](https://developers.google.com/protocol-buffers).</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        agency (str): an agency ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        obj: alert feed in protobuf format</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;get_alert_feed&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- agency: &#39;</span> <span class="o">+</span> <span class="n">agency</span><span class="p">)</span>

    <span class="n">purge_old_alerts</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_epoch_seconds</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">datastore_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="p">)</span>
    <span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;agency_key&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">agency</span><span class="p">)</span>
    <span class="n">query</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-time_stamp&quot;</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">20</span><span class="p">))</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">gtfs_realtime_pb2</span><span class="o">.</span><span class="n">FeedHeader</span><span class="p">()</span>
    <span class="n">header</span><span class="o">.</span><span class="n">gtfs_realtime_version</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>
    <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">now</span>

    <span class="n">feed</span> <span class="o">=</span> <span class="n">gtfs_realtime_pb2</span><span class="o">.</span><span class="n">FeedMessage</span><span class="p">()</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">alert_is_current</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="n">feed</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_alert</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">feed</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.get_current_block_collection">
<code class="highlight language-python"><span class="n">get_current_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Attempt to find the current block collection for a specific agency ID. Return from cache if present and fresh, consult DB otherwise.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency_id</code></td>
        <td><code>str</code></td>
        <td><p>an agency ID.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>obj</code></td>
      <td><p>the current block collection for <code>agency_id</code> if available, <code>None</code> otherwise</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_current_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to find the current block collection for a specific agency ID. Return from cache if present and fresh, consult DB otherwise.</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        agency_id (str): an agency ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        obj: the current block collection for `agency_id` if available, `None` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">block_collection</span> <span class="o">=</span> <span class="n">block_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- block_collection: </span><span class="si">{</span><span class="n">block_collection</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_current_time_millis</span><span class="p">()</span>
    <span class="n">yyymmdd</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_yyyymmdd</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">block_collection</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">yyymmdd</span> <span class="o">!=</span> <span class="n">block_collection</span><span class="p">[</span><span class="s1">&#39;valid_date&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;+ block collection not found or mismatched validity period, reloading from DB&#39;</span><span class="p">)</span>
        <span class="n">block_metadata</span> <span class="o">=</span> <span class="n">load_block_metadata</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">)</span>
        <span class="n">load_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">block_metadata</span><span class="p">)</span>
        <span class="n">block_collection</span> <span class="o">=</span> <span class="n">block_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">block_collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">-</span> <span class="n">block_collection</span><span class="p">[</span><span class="s1">&#39;last_refresh&#39;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">MAX_BLOCK_STALE_MILLIS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;+ block collection may be stale, reloading block metadata from DB&#39;</span><span class="p">)</span>
        <span class="n">block_metadata</span> <span class="o">=</span> <span class="n">load_block_metadata</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- block_metadata[&quot;created&quot;]       : </span><span class="si">{</span><span class="n">block_metadata</span><span class="p">[</span><span class="s2">&quot;created&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- block_collection[&quot;last_refresh&quot;]: </span><span class="si">{</span><span class="n">block_collection</span><span class="p">[</span><span class="s2">&quot;last_refresh&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">block_metadata</span><span class="p">[</span><span class="s1">&#39;created&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">block_collection</span><span class="p">[</span><span class="s1">&#39;last_refresh&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;+ block collection IS stale, reloading from DB&#39;</span><span class="p">)</span>
            <span class="n">load_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">block_metadata</span><span class="p">)</span>
            <span class="n">block_collection</span> <span class="o">=</span> <span class="n">block_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">block_collection</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.get_position_feed">
<code class="highlight language-python"><span class="n">get_position_feed</span><span class="p">(</span><span class="n">saved_position_feed</span><span class="p">,</span> <span class="n">saved_position_feed_millis</span><span class="p">,</span> <span class="n">vehicle_map</span><span class="p">,</span> <span class="n">agency</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Assemble position feed for an agency in the <a href="https://developers.google.com/protocol-buffers">protobuf format</a>, or return a recent cached instance.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>saved_position_feed</code></td>
        <td><code>dict</code></td>
        <td><p>dictionary mapping agency IDs to cached feed instances.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>saved_position_feed_millis</code></td>
        <td><code>dict</code></td>
        <td><p>dictionary mapping agency IDs to cache update timestamps.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>vehicle_map</code></td>
        <td><code>dict</code></td>
        <td><p>dictionary mapping vehicle IDs to position data.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency</code></td>
        <td><code>str</code></td>
        <td><p>an agency ID.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>obj</code></td>
      <td><p>position feed in protobuf format</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_position_feed</span><span class="p">(</span><span class="n">saved_position_feed</span><span class="p">,</span> <span class="n">saved_position_feed_millis</span><span class="p">,</span> <span class="n">vehicle_map</span><span class="p">,</span> <span class="n">agency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assemble position feed for an agency in the [protobuf format](https://developers.google.com/protocol-buffers), or return a recent cached instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        saved_position_feed (dict): dictionary mapping agency IDs to cached feed instances.</span>
<span class="sd">        saved_position_feed_millis (dict): dictionary mapping agency IDs to cache update timestamps.</span>
<span class="sd">        vehicle_map (dict): dictionary mapping vehicle IDs to position data.</span>
<span class="sd">        agency (str): an agency ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        obj: position feed in protobuf format</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">millis</span> <span class="o">=</span> <span class="n">saved_position_feed_millis</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">feed</span> <span class="o">=</span> <span class="n">saved_position_feed</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">millis</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">util</span><span class="o">.</span><span class="n">get_current_time_millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">millis</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+ returning cached feed message&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">feed</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">gtfs_realtime_pb2</span><span class="o">.</span><span class="n">FeedHeader</span><span class="p">()</span>
    <span class="n">header</span><span class="o">.</span><span class="n">gtfs_realtime_version</span> <span class="o">=</span> <span class="s1">&#39;2.0&#39;</span>
    <span class="n">header</span><span class="o">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_epoch_seconds</span><span class="p">()</span>

    <span class="n">feed</span> <span class="o">=</span> <span class="n">gtfs_realtime_pb2</span><span class="o">.</span><span class="n">FeedMessage</span><span class="p">()</span>
    <span class="n">feed</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vehicle_map</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">vehicle_map</span><span class="p">):</span>
            <span class="n">vehicle</span> <span class="o">=</span> <span class="n">vehicle_map</span><span class="p">[</span><span class="nb">id</span><span class="p">];</span>

            <span class="n">vts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_epoch_seconds</span><span class="p">()</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">vts</span>

            <span class="k">if</span> <span class="n">delta</span> <span class="o">&gt;=</span> <span class="n">MAX_LIFE</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">vehicle_map</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">feed</span><span class="o">.</span><span class="n">entity</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_position</span><span class="p">(</span>
                    <span class="nb">id</span><span class="p">,</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;lat&#39;</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;long&#39;</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;heading&#39;</span><span class="p">]),</span>
                    <span class="nb">float</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;speed&#39;</span><span class="p">]),</span>
                    <span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;trip-id&#39;</span><span class="p">],</span>
                    <span class="nb">int</span><span class="p">(</span><span class="n">vehicle</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
                <span class="p">));</span>

    <span class="n">saved_position_feed</span><span class="p">[</span><span class="n">agency</span><span class="p">]</span> <span class="o">=</span> <span class="n">feed</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span>
    <span class="n">saved_position_feed_millis</span><span class="p">[</span><span class="n">agency</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_current_time_millis</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;+ created new feed message at &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">saved_position_feed_millis</span><span class="p">[</span><span class="n">agency</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">saved_position_feed</span><span class="p">[</span><span class="n">agency</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.get_trip_id">
<code class="highlight language-python"><span class="n">get_trip_id</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Attempt to find a trip ID for a specific agency ID and vehicle ID and the current time.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency_id</code></td>
        <td><code>str</code></td>
        <td><p>an agency ID.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>vehicle_id</code></td>
        <td><code>str</code></td>
        <td><p>a vehicle ID.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p>a trip ID if one could be determined using block assignment data, <code>None</code> otherwise</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_trip_id</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">,</span> <span class="n">vehicle_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to find a trip ID for a specific agency ID and vehicle ID and the current time.</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        agency_id (str): an agency ID.</span>
<span class="sd">        vehicle_id (str): a vehicle ID.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: a trip ID if one could be determined using block assignment data, `None` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;get_trip_id()&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- agency_id: </span><span class="si">{</span><span class="n">agency_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- vehicle_id: </span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">block_collection</span> <span class="o">=</span> <span class="n">get_current_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">block_collection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no block collection found for agency </span><span class="si">{</span><span class="n">agency_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">block</span> <span class="o">=</span> <span class="n">block_collection</span><span class="p">[</span><span class="s1">&#39;blocks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">vehicle_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">block</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no block data found for vehicle </span><span class="si">{</span><span class="n">vehicle_id</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">agency_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">day_seconds</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_seconds_since_midnight</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">trip</span> <span class="ow">in</span> <span class="n">block</span><span class="p">[</span><span class="s1">&#39;trips&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;++++++++++++++++++++++++++++&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;++ secs : </span><span class="si">{</span><span class="n">day_seconds</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;++ start: </span><span class="si">{</span><span class="n">trip</span><span class="p">[</span><span class="s2">&quot;start_time&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;++ end  : </span><span class="si">{</span><span class="n">trip</span><span class="p">[</span><span class="s2">&quot;end_time&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">day_seconds</span> <span class="o">&gt;=</span> <span class="n">trip</span><span class="p">[</span><span class="s1">&#39;start_time&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">day_seconds</span> <span class="o">&lt;</span> <span class="n">trip</span><span class="p">[</span><span class="s1">&#39;end_time&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="n">trip</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.handle_block_collection">
<code class="highlight language-python"><span class="n">handle_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Handle an incoming block collection. A collection has metadata like the associated agency ID, the date it is valid for, and the actual list of blocks, each of which has an ID and a list of contained trip IDs. The function checks if the collection contains the required data and discards it with an error message if it doesn't. Otherwise the data is structured for efficient access through caching and database and written to said database:
- assignment summary: a shorthand list of which block ID is matched with which vehicle ID
- block collection: a detailed list where each entry has a block id and a list of associated trip IDs
- metadata: an agency ID, a valid date and DB keys to and <code>assignment-summary</code> record and a <code>block-list</code> record</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>obj</code></td>
        <td><p>JSON data containing the agency ID, valid date and actual block list.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>str</code></td>
      <td><p><code>ok</code> if everything went well, otherwise an error message</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle_block_collection</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle an incoming block collection. A collection has metadata like the associated agency ID, the date it is valid for, and the actual list of blocks, each of which has an ID and a list of contained trip IDs. The function checks if the collection contains the required data and discards it with an error message if it doesn&#39;t. Otherwise the data is structured for efficient access through caching and database and written to said database:</span>
<span class="sd">    - assignment summary: a shorthand list of which block ID is matched with which vehicle ID</span>
<span class="sd">    - block collection: a detailed list where each entry has a block id and a list of associated trip IDs</span>
<span class="sd">    - metadata: an agency ID, a valid date and DB keys to and `assignment-summary` record and a `block-list` record</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        data (obj): JSON data containing the agency ID, valid date and actual block list.</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: `ok` if everything went well, otherwise an error message</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;handle_block_collection()&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_current_time_millis</span><span class="p">()</span>
    <span class="n">agency_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agency_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">valid_date</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;valid_date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">blocks</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;blocks&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">agency_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* block collection is missing </span><span class="se">\&#39;</span><span class="s1">agency_id</span><span class="se">\&#39;</span><span class="s1"> field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;error: missing agency ID&#39;</span>

    <span class="k">if</span> <span class="n">valid_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* block collection is missing </span><span class="se">\&#39;</span><span class="s1">valid_date</span><span class="se">\&#39;</span><span class="s1"> field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;error: missing </span><span class="se">\&#39;</span><span class="s1">valid_date</span><span class="se">\&#39;</span><span class="s1"> field&#39;</span>

    <span class="k">if</span> <span class="n">blocks</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* block collection is missing </span><span class="se">\&#39;</span><span class="s1">blocks</span><span class="se">\&#39;</span><span class="s1"> field&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;error: no blocks&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">blocks</span><span class="p">:</span>
            <span class="n">assignments</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;block_id&#39;</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;vehicle_id&#39;</span><span class="p">:</span> <span class="n">block</span><span class="p">[</span><span class="s1">&#39;vehicle_id&#39;</span><span class="p">]</span>
            <span class="p">})</span>

        <span class="n">assignment_summary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- assignment_summary: </span><span class="si">{</span><span class="n">assignment_summary</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">entity1</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">datastore_client</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s1">&#39;assignment-summary&#39;</span><span class="p">),</span> <span class="n">exclude_from_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
        <span class="n">entity1</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">assignment_summary</span><span class="p">)</span>
        <span class="n">datastore_client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entity1</span><span class="p">)</span>

        <span class="n">block_list</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">blocks</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- block_list: </span><span class="si">{</span><span class="n">block_list</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">entity2</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">datastore_client</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s1">&#39;block-list&#39;</span><span class="p">),</span> <span class="n">exclude_from_indexes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span>
        <span class="n">entity2</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block_list</span><span class="p">)</span>
        <span class="n">datastore_client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entity2</span><span class="p">)</span>

        <span class="n">block_metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;created&#39;</span><span class="p">:</span> <span class="n">now</span><span class="p">,</span>
            <span class="s1">&#39;agency_id&#39;</span><span class="p">:</span> <span class="n">agency_id</span><span class="p">,</span>
            <span class="s1">&#39;valid_date&#39;</span><span class="p">:</span> <span class="n">valid_date</span><span class="p">,</span>
            <span class="s1">&#39;assignment_summary_key&#39;</span><span class="p">:</span> <span class="n">entity1</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="s1">&#39;block_list_key&#39;</span><span class="p">:</span> <span class="n">entity2</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- block_metadata: </span><span class="si">{</span><span class="n">block_metadata</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">entity</span> <span class="o">=</span> <span class="n">datastore</span><span class="o">.</span><span class="n">Entity</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">datastore_client</span><span class="o">.</span><span class="n">key</span><span class="p">(</span><span class="s1">&#39;block-metadata&#39;</span><span class="p">))</span>
        <span class="n">entity</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block_metadata</span><span class="p">)</span>
        <span class="n">datastore_client</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span>

        <span class="n">query</span> <span class="o">=</span> <span class="n">datastore_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;block-metadata&quot;</span><span class="p">)</span>
        <span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">now</span> <span class="o">-</span> <span class="n">WEEK_MILLIS</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- results: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
            <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;block_list_key&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;block_list_key&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="s1">&#39;assignment_summary_key&#39;</span> <span class="ow">in</span> <span class="n">r</span><span class="p">:</span>
                <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;assignment_summary_key&#39;</span><span class="p">])</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- keys: </span><span class="si">{</span><span class="n">keys</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">datastore_client</span><span class="o">.</span><span class="n">delete_multi</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;error: exception&#39;</span>

    <span class="k">return</span> <span class="s1">&#39;ok&#39;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.handle_get_assignments">
<code class="highlight language-python"><span class="n">handle_get_assignments</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get a list of assigned block IDs and vehicle IDs for a specific agency and date.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>obj</code></td>
        <td><p>JSON data containing <code>agency_id</code> and <code>date</code> fields.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>array</code></td>
      <td><p>list of assignments if everything is in order, an empty array otherwise</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle_get_assignments</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a list of assigned block IDs and vehicle IDs for a specific agency and date.</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        data (obj): JSON data containing `agency_id` and `date` fields.</span>

<span class="sd">    Returns:</span>
<span class="sd">        array: list of assignments if everything is in order, an empty array otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;handle_get_assignments()&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- data: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">agency_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agency_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">agency_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no agency or date given for assignments request&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="n">load_block_metadata</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no metadata found for assignments request&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="n">assignment_summary</span> <span class="o">=</span> <span class="n">datastore_client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;assignment_summary_key&#39;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">assignment_summary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no record found for key </span><span class="si">{</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;assignment_summary_key&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">assignment_summary</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.handle_pos_update">
<code class="highlight language-python"><span class="n">handle_pos_update</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">timestamp_map</span><span class="p">,</span> <span class="n">agency_map</span><span class="p">,</span> <span class="n">position_lock</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Handle an incoming vehicle postion update. If the update is missing a trip ID, check if we have block assignment data to let us backfill the ID. Write update to DB and update internal data structures with the received data.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>timestamp_map</code></td>
        <td><code>dict</code></td>
        <td><p>dictionary of vehicle UUIDs to last received timestamp.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency_map</code></td>
        <td><code>dict</code></td>
        <td><p>hierarchical dictionary of vehicle position data.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>position_lock</code></td>
        <td><code>obj</code></td>
        <td><p>concurency lock for access to agency_map.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">handle_pos_update</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">timestamp_map</span><span class="p">,</span> <span class="n">agency_map</span><span class="p">,</span> <span class="n">position_lock</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handle an incoming vehicle postion update. If the update is missing a trip ID, check if we have block assignment data to let us backfill the ID. Write update to DB and update internal data structures with the received data.</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        timestamp_map (dict): dictionary of vehicle UUIDs to last received timestamp.</span>
<span class="sd">        agency_map (dict): hierarchical dictionary of vehicle position data.</span>
<span class="sd">        position_lock (obj): concurency lock for access to agency_map.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span><span class="p">[</span><span class="s1">&#39;rcv-timestamp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_epoch_seconds</span><span class="p">()</span>

    <span class="c1">### TODO check if &#39;use-bulk-assignment-mode&#39; == True</span>
    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;trip-id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trip_id</span> <span class="o">=</span> <span class="n">get_trip_id</span><span class="p">(</span>
            <span class="n">datastore_client</span><span class="p">,</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;agency-id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
            <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;vehicle-id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- trip_id: </span><span class="si">{</span><span class="n">trip_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">trip_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* discarding position update without trip ID: </span><span class="si">{</span><span class="n">data</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">data</span><span class="p">[</span><span class="s1">&#39;trip_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">trip_id</span>

    <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;replay&#39;</span><span class="p">:</span>
        <span class="n">add_position</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

    <span class="n">prev_timestamp</span> <span class="o">=</span> <span class="n">timestamp_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">],</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">prev_timestamp</span> <span class="ow">and</span> <span class="nb">int</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">prev_timestamp</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{&quot;command&quot;: &quot;new-pos&quot;, &quot;status&quot;: &quot;out-of-sequence&quot;}&#39;</span>

    <span class="n">timestamp_map</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;uuid&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">]</span>

    <span class="n">position_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">();</span>
    <span class="n">agency</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;agency-id&#39;</span><span class="p">];</span>
    <span class="n">vehicle_map</span> <span class="o">=</span> <span class="n">agency_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">vehicle_map</span><span class="p">:</span>
        <span class="n">vehicle_map</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">agency_map</span><span class="p">[</span><span class="n">agency</span><span class="p">]</span> <span class="o">=</span> <span class="n">vehicle_map</span>
    <span class="n">vehicle_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;vehicle-id&#39;</span><span class="p">];</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- vehicle_id: &#39;</span> <span class="o">+</span> <span class="n">vehicle_id</span><span class="p">)</span>
    <span class="n">vehicle_map</span><span class="p">[</span><span class="n">vehicle_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">position_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.gtfsrt.load_block_metadata">
<code class="highlight language-python"><span class="n">load_block_metadata</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">,</span> <span class="n">date_string</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Attempt to find and return block metadata for a specific agency ID and date.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>datastore_client</code></td>
        <td><code>obj</code></td>
        <td><p>reference to google cloud datastore instance.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>agency_id</code></td>
        <td><code>str</code></td>
        <td><p>an agency ID.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>date_string</code></td>
        <td><code>str</code></td>
        <td><p>a date. Current date if omitted.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>obj</code></td>
      <td><p>metadata instance if available, <code>None</code> otherwise</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/gtfsrt.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">load_block_metadata</span><span class="p">(</span><span class="n">datastore_client</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">,</span> <span class="n">date_string</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to find and return block metadata for a specific agency ID and date.</span>

<span class="sd">    Args:</span>
<span class="sd">        datastore_client (obj): reference to google cloud datastore instance.</span>
<span class="sd">        agency_id (str): an agency ID.</span>
<span class="sd">        date_string (str): a date. Current date if omitted.</span>

<span class="sd">    Returns:</span>
<span class="sd">        obj: metadata instance if available, `None` otherwise</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;load_block_metadata()&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- agency_id: </span><span class="si">{</span><span class="n">agency_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">date_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date_string</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_yyyymmdd</span><span class="p">()</span>

    <span class="n">query</span> <span class="o">=</span> <span class="n">datastore_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;block-metadata&quot;</span><span class="p">)</span>
    <span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;agency_id&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">agency_id</span><span class="p">)</span>
    <span class="n">query</span><span class="o">.</span><span class="n">add_filter</span><span class="p">(</span><span class="s2">&quot;valid_date&quot;</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="n">date_string</span><span class="p">)</span>
    <span class="n">query</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;-created&quot;</span><span class="p">]</span>

    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">limit</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;- results: </span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;* no matching block metadata for agency </span><span class="se">\&#39;</span><span class="si">{</span><span class="n">agency_id</span><span class="si">}</span><span class="se">\&#39;</span><span class="s1"> valid on </span><span class="si">{</span><span class="n">date_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div>
        </details>
    </div>

  </div>











  </div>

    </div>

  </div>






  <div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="server.app-engine.main">
        <code>main</code>



</h2>

    <div class="doc doc-contents ">

      <p>Implement functionality for a GTFS-rt server. GTFS-rt spec is here: https://developers.google.com/transit/gtfs-realtime</p>
<p>The server currently supports two of the three feed types from the spec: Vehicle Positions and Service Alerts.</p>
<p>An implementation for Trip Updates is underway. For authentication, updates have to be signed with the private key
for an agency. Public agency keys need to be added to the system database. The server will read public keys from
the database at startup.</p>
<p>There is a proof-of-concept implementation for a Service Alert UI called AlertUI in the gtfu folder. Alerts can
also be submitted through 3rd party tools using HTTP POST and the /post-alert endpoint below.</p>
<p>Clients can submit alert updates for individual feeds through the following endpoint:</p>
<pre><code>/post-alert:
{
    "data": {
        "agency_key": ...,  # id of submitting agency
        "cause": ...,       # enumerated cause value
        "description": ..., # alert description
        "effect": ...,      # enumerated effect value
        "header": ...,      # summary
        "time_stamp": ...,  # when the message was created
        "time_start": ...,  # start of valid time period
        "time_stop": ...    # end of valid time period
    },
    "sig": ...              # base-64 encoded ECDSA signature of "data" object
}
</code></pre>
<p>Clients can submit position updates for individual feeds through the following endpoint:</p>
<pre><code>/new-pos-sig:
{
    "data": {
        "accuracy": ...,      # accuracy of update
        "agency-id": ...,     # id of submitting agency
        "agent": ...,         # user agent of client
        "driver-name": ...,   # name of driver
        "heading": ...,       # vhicle heading in degrees
        "lat": ...,           # lattitide of vehicle
        "long": ...,          # longitude of vehicle
        "speed": ...,         # vehicle speed
        "timestamp": ...,     # when update was generated
        "trip-id": ...,       # trip id
        "uuid": ...,          # unique user id
        "vehicle-id": ...,    # vehicle id
        "version": ...        # client version
    },
    "sig": ...                # base-64 encoded ECDSA signature of "data" object
}
</code></pre>
<p>Consumers can retrieve current service alerts for an agency through the following endpoints:</p>
<pre><code>/service-alerts.pb?agency=MY-AGENCY-ID
</code></pre>
<p>Consumers can retrieve current vehicle positions for an agency through the following endpoints:</p>
<pre><code>/vehicle-positions.pb?agency=MY-AGENCY-ID
</code></pre>
<p>A web-based client for collecting and submitting vehicle position updates is available at this endpoint:</p>
<pre><code>/
</code></pre>
<p><em>Note that at first ever startup, client needs to be initialized with QR code that contains agency ID and private key.</em></p>
<p>A web-based client for bulk-assigning GTFS blocks to vehicles is available at this endpoint:</p>
<pre><code>/dispatch-ui
</code></pre>
<p><em>Note that at first ever startup, client needs to be initialized with QR code that contains agency ID and private key.</em></p>
<p>Please note:
  For simplicity reasons, server currently only works reliably with a single instance. memcache implementation
  with support for multiple instances is forthcoming</p>
<p>See how-to-run.txt in this folder for details on how to run the server both locally and in the cloud.</p>



  <div class="doc doc-children">



































  </div>

    </div>

  </div>








  <div class="doc doc-object doc-module">



<h2 class="doc doc-heading" id="server.app-engine.util">
        <code>util</code>



</h2>

    <div class="doc doc-contents ">

      <p>Various utility functions, centered mostly around cryptography and date/time.</p>



  <div class="doc doc-children">















  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.get_current_time_millis">
<code class="highlight language-python"><span class="n">get_current_time_millis</span><span class="p">()</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get the number of milliseconds since the epoch.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of milliseonds since the epoch.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_current_time_millis</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Get the number of milliseconds since the epoch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of milliseonds since the epoch.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">))</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.get_epoch_seconds">
<code class="highlight language-python"><span class="n">get_epoch_seconds</span><span class="p">(</span><span class="n">date_string</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get the number of seconds since the epoch for a date string. If date string is omitted, the current date is assumed.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>date_string</code></td>
        <td><code>str</code></td>
        <td><p>a date in the form of <code>yyyy-mm-dd</code>.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of seconds since the epoch for a date string.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_epoch_seconds</span><span class="p">(</span><span class="n">date_string</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the number of seconds since the epoch for a date string. If date string is omitted, the current date is assumed.</span>

<span class="sd">    Args:</span>
<span class="sd">        date_string (str): a date in the form of `yyyy-mm-dd`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of seconds since the epoch for a date string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">date_string</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;+ ts: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_string</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;+ ts: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.get_midnight_seconds">
<code class="highlight language-python"><span class="n">get_midnight_seconds</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get the number of seconds at midnight of the provided timestamp.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>epoch_seconds</code></td>
        <td><code>int</code></td>
        <td><p>a timestamp given in number of seconds since the epoch.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of seconds at midnight of the provided timestamp.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_midnight_seconds</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the number of seconds at midnight of the provided timestamp.</span>

<span class="sd">    Args:</span>
<span class="sd">        epoch_seconds (int): a timestamp given in number of seconds since the epoch.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of seconds at midnight of the provided timestamp.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">epoch_seconds</span><span class="p">)</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;. ts: </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">timestamp</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.get_seconds_since_midnight">
<code class="highlight language-python"><span class="n">get_seconds_since_midnight</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get the number of seconds since midnight of the provided timestamp.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>seconds</code></td>
        <td><code>int</code></td>
        <td><p>a timestamp given in number of seconds since the epoch. If omitted, the current timestamp is assumed.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of seconds since midnight of the provided timestamp.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_seconds_since_midnight</span><span class="p">(</span><span class="n">seconds</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get the number of seconds since midnight of the provided timestamp.</span>

<span class="sd">    Args:</span>
<span class="sd">        seconds (int): a timestamp given in number of seconds since the epoch. If omitted, the current timestamp is assumed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of seconds since midnight of the provided timestamp.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>

    <span class="n">now</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">now</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">now</span> <span class="o">-</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">microsecond</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.get_yyyymmdd">
<code class="highlight language-python"><span class="n">get_yyyymmdd</span><span class="p">(</span><span class="n">date</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Get a string representation of the given date in the form <code>yyyy-mm-dd</code>.</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>date</code></td>
        <td><code>datetime</code></td>
        <td><p>a datetime object for which to generate a date string. If omitted, the current date and time is assumed.</p></td>
        <td><code>None</code></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>int</code></td>
      <td><p>The number of seconds since midnight of the provided timestamp.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">get_yyyymmdd</span><span class="p">(</span><span class="n">date</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get a string representation of the given date in the form `yyyy-mm-dd`.</span>

<span class="sd">    Args:</span>
<span class="sd">        date (datetime): a datetime object for which to generate a date string. If omitted, the current date and time is assumed.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The number of seconds since midnight of the provided timestamp.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

    <span class="n">date</span> <span class="o">=</span> <span class="n">PACIFIC_TZ</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">year</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">month</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">day</span><span class="si">}</span><span class="s1">&#39;</span>
</code></pre></div>
        </details>
    </div>

  </div>



  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.read_public_keys">
<code class="highlight language-python"><span class="n">read_public_keys</span><span class="p">()</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Read public keys for agencies from DB and return as dictionary that maps IDs to keys.</p>

<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>dict</code></td>
      <td><p>Dictionary that maps IDs to keys.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">read_public_keys</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Read public keys for agencies from DB and return as dictionary that maps IDs to keys.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: Dictionary that maps IDs to keys.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;reading agency IDs and public keys from DB:&#39;</span><span class="p">)</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">datastore_client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;agency&quot;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">query</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
    <span class="n">key_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">agency</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- id: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agency</span><span class="p">[</span><span class="s1">&#39;agency-id&#39;</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-- key: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agency</span><span class="p">[</span><span class="s1">&#39;public-key&#39;</span><span class="p">]))</span>
        <span class="n">key_map</span><span class="p">[</span><span class="n">agency</span><span class="p">[</span><span class="s1">&#39;agency-id&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">agency</span><span class="p">[</span><span class="s1">&#39;public-key&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">key_map</span>
</code></pre></div>
        </details>
    </div>

  </div>




  <div class="doc doc-object doc-function">



<h3 class="doc doc-heading" id="server.app-engine.util.verify_signature">
<code class="highlight language-python"><span class="n">verify_signature</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span></code>


</h3>

    <div class="doc doc-contents ">

      <p>Verify the signature of some data. Signature is assumed to be in ECDSA-256 format</p>

<p><strong>Parameters:</strong></p>
<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Type</th>
      <th>Description</th>
      <th>Default</th>
    </tr>
  </thead>
  <tbody>
      <tr>
        <td><code>agency_id</code></td>
        <td><code>str</code></td>
        <td><p>Agency ID, used to retrieve public key for agency.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>data</code></td>
        <td><code>str</code></td>
        <td><p>The data to be verified.</p></td>
        <td><em>required</em></td>
      </tr>
      <tr>
        <td><code>signature</code></td>
        <td><code>str</code></td>
        <td><p>The signature to use for verification.</p></td>
        <td><em>required</em></td>
      </tr>
  </tbody>
</table>
<p><strong>Returns:</strong></p>
<table>
  <thead>
    <tr>
      <th>Type</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code>bool</code></td>
      <td><p>True if signature could be verified, False otherwise.</p></td>
    </tr>
  </tbody>
</table>
        <details class="quote">
          <summary>Source code in <code>app-engine/util.py</code></summary>
          <div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">verify_signature</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">signature</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Verify the signature of some data. Signature is assumed to be in ECDSA-256 format</span>

<span class="sd">    Args:</span>
<span class="sd">        agency_id (str): Agency ID, used to retrieve public key for agency.</span>
<span class="sd">        data (str): The data to be verified.</span>
<span class="sd">        signature (str): The signature to use for verification.</span>

<span class="sd">    Returns:</span>
<span class="sd">        bool: True if signature could be verified, False otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">last_key_refresh</span><span class="p">,</span> <span class="n">last_bucket_check</span><span class="p">,</span> <span class="n">key_map</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;verify_signature()&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- agency_id: &#39;</span> <span class="o">+</span> <span class="n">agency_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- data: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- key: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;no public key for agency ID: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">agency_id</span><span class="p">))</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">get_current_time_millis</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Now: </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Last time bucket was checked: </span><span class="si">{</span><span class="n">last_bucket_check</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1"># If we haven&#39;t checked the bucket for a new timestamp in the last minute, check now</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">-</span> <span class="n">last_bucket_check</span> <span class="o">&gt;</span> <span class="n">ONE_MINUTE_MILLIS</span><span class="p">):</span>
            <span class="n">last_bucket_check</span> <span class="o">=</span> <span class="n">now</span>
            <span class="n">last_key_update</span> <span class="o">=</span> <span class="n">get_bucket_timestamp</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Last time public key was updated: </span><span class="si">{</span><span class="n">last_key_update</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Last time public keys were refreshed: </span><span class="si">{</span><span class="n">last_key_refresh</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># If a key update has happened since the last refresh, and we haven&#39;t refreshed in the last minute, reload keys and then continue with verification</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">last_key_update</span> <span class="o">&gt;</span> <span class="n">last_key_refresh</span> <span class="ow">and</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_key_refresh</span> <span class="o">&gt;</span> <span class="n">ONE_MINUTE_MILLIS</span><span class="p">):</span>
                <span class="n">last_key_refresh</span> <span class="o">=</span> <span class="n">now</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Re-running read_public_keys()...&#39;</span><span class="p">)</span>
                <span class="n">key_map</span> <span class="o">=</span> <span class="n">read_public_keys</span><span class="p">()</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">key_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">agency_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="p">:</span>
                    <span class="c1"># If there IS a key in key_map for agency_id, verify_signature will continue with verification</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- signature: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">signature</span><span class="p">))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">vk</span> <span class="o">=</span> <span class="n">ecdsa</span><span class="o">.</span><span class="n">VerifyingKey</span><span class="o">.</span><span class="n">from_der</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">sha256</span><span class="p">)</span>
            <span class="n">verified</span> <span class="o">=</span> <span class="n">vk</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">signature</span><span class="p">),</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- ECDSA verified: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">verified</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">verified</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* ECDSA verification failure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rsakey</span> <span class="o">=</span> <span class="n">RSA</span><span class="o">.</span><span class="n">importKey</span><span class="p">(</span><span class="n">b64decode</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">signer</span> <span class="o">=</span> <span class="n">PKCS1_v1_5</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">rsakey</span><span class="p">)</span>
            <span class="n">digest</span> <span class="o">=</span> <span class="n">SHA256</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
            <span class="n">digest</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
            <span class="n">verified</span> <span class="o">=</span> <span class="n">signer</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="n">b64decode</span><span class="p">(</span><span class="n">signature</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- RSA verified: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">verified</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">verified</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* RSA verification failure: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div>
        </details>
    </div>

  </div>






  </div>

    </div>

  </div>





  </div>

    </div>

  </div>

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../hardware/" class="md-footer__link md-footer__link--prev" aria-label="Previous: GRaaS hardware intro and assembly" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              GRaaS hardware intro and assembly
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.c44cc438.min.js"></script>
      
    
  </body>
</html>